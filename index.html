<div id="vista-pasajero" class="hidden">
    <div style="text-align:center; font-weight:bold; color:#2e7d32; margin-bottom:10px;">TARIFA NICA: $5.000</div>
    <input type="text" id="destino" placeholder=" Toca el mapa o escribe tu destino">
    
    <div id="info-moto" style="text-align:center; margin:10px 0; font-size:14px; color:#555;">
        Toca una moto azul para llamar
    </div>

    <a id="btn-llamar" href="#" class="btn-blue" style="text-decoration:none; display:none; text-align:center; line-height:30px; background:#28a745;"> LLAMAR CONDUCTOR</a>
    
    <button class="btn-yellow" onclick="solicitarServicio()">SOLICITAR AHORA</button>
    <button onclick="location.reload()">Volver</button>
</div>

<script type="module">
    // ... (Mant茅n tu configuraci贸n de Firebase igual)

    // --- CORRECCIN DE LA LGICA DE DESTINO ---
    // Esta funci贸n se asegura de que al tocar el mapa se escriba la direcci贸n
    map.on('click', function(e) {
        // Obtenemos las coordenadas
        const lat = e.latlng.lat.toFixed(5);
        const lng = e.latlng.lng.toFixed(5);
        
        // Colocamos un marcador rojo en el destino
        if (window.marcadorDestino) {
            map.removeLayer(window.marcadorDestino);
        }
        window.marcadorDestino = L.marker(e.latlng, {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41]
            })
        }).addTo(map);

        // Llenamos el campo de texto autom谩ticamente
        document.getElementById('destino').value = "Ubicaci贸n: " + lat + ", " + lng;
        console.log("Destino marcado correctamente");
    });

    window.solicitarServicio = () => {
        const destino = document.getElementById('destino').value;
        if(!destino) {
            alert("Por favor, toca el mapa para indicar a d贸nde vas o escribe la direcci贸n.");
            return;
        }
        alert("隆Solicitud enviada! Toca la moto azul m谩s cercana para llamar al conductor y confirmar.");
    };

    // --- REVISIN DE LAS MOTOS AZULES ---
    function escucharMotos() {
        onValue(ref(db, 'conductores/'), (snap) => {
            const data = snap.val();
            for(let id in data){
                if(!motoMarkers[id]){
                    motoMarkers[id] = L.marker([data[id].lat, data[id].lng], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', 
                            iconSize:[25,41]
                        })
                    }).addTo(map);

                    // Al hacer clic en la moto, activamos el bot贸n de llamar
                    motoMarkers[id].on('click', function() {
                        document.getElementById('info-moto').innerHTML = " Conductor: <b>" + data[id].nombre + "</b>";
                        const btnLlamar = document.getElementById('btn-llamar');
                        btnLlamar.href = "tel:" + data[id].telefono;
                        btnLlamar.style.display = "block";
                    });
                } else {
                    motoMarkers[id].setLatLng([data[id].lat, data[id].lng]);
                }
            }
        });
    }
</script>
